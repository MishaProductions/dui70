#pragma once

namespace DirectUI
{
	struct UpdateCache
	{
		// ??
	};

	//32位数据结构大小 0x80
	class UILIB_API Element
	{
	public:
		//0 虚表指针
		//_vftable_

		//0x4
		UINT32 v4;

		//0x8
		UINT32 v5;

		//0xC
		UINT32 v13;

		//0x10
		UINT32 v1;

		//0x14
		UINT32 v7;

		//0x18
		UINT32 v11;

		//0x1C
		UINT32 v12;

		//0x20
		byte v30[4];

		//0x24
		UINT32 v6;

		//0x28
		UINT32 v14;

		//0x2C
		UINT32 v15;

		//0x30
		UINT32 v16;

		//0x34
		UINT32 v17;

		//0x38
		UINT32 v18;

		//0x3C
		UINT32 v19;

		//0x40
		UINT32 v20;

		//0x44
		UINT32 v21;

		//0x48
		UINT32 v22;

		//0x4C
		UINT32 v23;

		//0x50
		UINT32 v24;

		//0x54
		UINT32 v25;

		//0x58
		UINT32 v26;

		//0x5C
		UINT32 v27;

		//0x60
		UINT32 v60;

		//0x64
		UINT8 v64;

		//0x65
		UINT8 v10;

		//0x66
		UINT8 v66;

		//0x67
		UINT8 v8;

		//0x68
		UINT8 v9;

		//0x69
		//4对齐上移0x6C

		//0x6C
		UINT32 v29;


		//0x78
		UINT32 v2;

		//0x7C
		UINT32 v3;
		UINT32 va0;
		UINT32 va1;
		UINT32 va2;
		UINT32 va3;
		UINT32 va4;
		UINT32 va5;
		UINT32 va6;
		UINT32 va7;
		UINT32 va8;
		UINT32 va9;
		UINT32 va10;
		UINT32 va11;
		UINT32 va12;
		UINT32 va13;
		UINT32 va14;
		UINT32 va15;
		UINT32 va16;
		UINT32 va17;
		UINT32 va18;
		UINT32 va19;
		UINT32 va20;
		UINT32 va21;
		UINT32 va22;
		UINT32 va23;
		UINT32 va24;
		UINT32 va25;
		UINT32 va26;
		UINT32 va27;
		UINT32 va28;
		UINT32 va29;
		UINT32 va30;
		UINT32 va31;
		UINT32 va32;
		UINT32 va33;
		UINT32 va34;
		UINT32 va35;
		UINT32 va36;
		UINT32 va37;
		UINT32 va38;
		UINT32 va39;
		UINT32 va40;
		UINT32 va41;
		UINT32 va42;
		UINT32 va43;
		UINT32 va44;
		UINT32 va45;
		UINT32 va46;
		UINT32 va47;
		UINT32 va48;
		UINT32 va49;
		UINT32 va50;
		UINT32 va51;
		UINT32 va52;
		UINT32 va53;
		UINT32 va54;
		UINT32 va55;
		UINT32 va56;
		UINT32 va57;
		UINT32 va58;
		UINT32 va59;
		UINT32 va60;
		UINT32 va61;
		UINT32 va62;
		UINT32 va63;
		UINT32 va64;
		UINT32 va65;
		UINT32 va66;
		UINT32 va67;
		UINT32 va68;
		UINT32 va69;
		UINT32 va70;
		UINT32 va71;
		UINT32 va72;
		UINT32 va73;
		UINT32 va74;
		UINT32 va75;
		UINT32 va76;
		UINT32 va77;
		UINT32 va78;
		UINT32 va79;
		UINT32 va80;
		UINT32 va81;
		UINT32 va82;
		UINT32 va83;
		UINT32 va84;
		UINT32 va85;
		UINT32 va86;
		UINT32 va87;
		UINT32 va88;
		UINT32 va89;
		UINT32 va90;
		UINT32 va91;
		UINT32 va92;
		UINT32 va93;
		UINT32 va94;
		UINT32 va95;
		UINT32 va96;
		UINT32 va97;
		UINT32 va98;
		UINT32 va99;
		UINT32 va100;
		UINT32 va101;
		UINT32 va102;
		UINT32 va103;
		UINT32 va104;
		UINT32 va105;
		UINT32 va106;
		UINT32 va107;
		UINT32 va108;
		UINT32 va109;
		UINT32 va110;
		UINT32 va111;
		UINT32 va112;
		UINT32 va113;
		UINT32 va114;
		UINT32 va115;
		UINT32 va116;
		UINT32 va117;
		UINT32 va118;
		UINT32 va119;
		UINT32 va120;
		UINT32 va121;
		UINT32 va122;
		UINT32 va123;
		UINT32 va124;
		UINT32 va125;
		UINT32 va126;
		UINT32 va127;
		UINT32 va128;
		UINT32 va129;
		UINT32 va130;
		UINT32 va131;
		UINT32 va132;
		UINT32 va133;
		UINT32 va134;
		UINT32 va135;
		UINT32 va136;
		UINT32 va137;
		UINT32 va138;
		UINT32 va139;
		UINT32 va140;
		UINT32 va141;
		UINT32 va142;
		UINT32 va143;
		UINT32 va144;
		UINT32 va145;
		UINT32 va146;
		UINT32 va147;
		UINT32 va148;
		UINT32 va149;
		UINT32 va150;
		UINT32 va151;
		UINT32 va152;
		UINT32 va153;
		UINT32 va154;
		UINT32 va155;
		UINT32 va156;
		UINT32 va157;
		UINT32 va158;
		UINT32 va159;
		UINT32 va160;
		UINT32 va161;
		UINT32 va162;
		UINT32 va163;
		UINT32 va164;
		UINT32 va165;
		UINT32 va166;
		UINT32 va167;
		UINT32 va168;
		UINT32 va169;
		UINT32 va170;
		UINT32 va171;
		UINT32 va172;
		UINT32 va173;
		UINT32 va174;
		UINT32 va175;
		UINT32 va176;
		UINT32 va177;
		UINT32 va178;
		UINT32 va179;
		UINT32 va180;
		UINT32 va181;
		UINT32 va182;
		UINT32 va183;
		UINT32 va184;
		UINT32 va185;
		UINT32 va186;
		UINT32 va187;
		UINT32 va188;
		UINT32 va189;
		UINT32 va190;
		UINT32 va191;
		UINT32 va192;
		UINT32 va193;
		UINT32 va194;
		UINT32 va195;
		UINT32 va196;
		UINT32 va197;
		UINT32 va198;
		UINT32 va199;
		UINT32 va200;
		UINT32 va201;
		UINT32 va202;
		UINT32 va203;
		UINT32 va204;
		UINT32 va205;
		UINT32 va206;
		UINT32 va207;
		UINT32 va208;
		UINT32 va209;
		UINT32 va210;
		UINT32 va211;
		UINT32 va212;
		UINT32 va213;
		UINT32 va214;
		UINT32 va215;
		UINT32 va216;
		UINT32 va217;
		UINT32 va218;
		UINT32 va219;
		UINT32 va220;
		UINT32 va221;
		UINT32 va222;
		UINT32 va223;
		UINT32 va224;
		UINT32 va225;
		UINT32 va226;
		UINT32 va227;
		UINT32 va228;
		UINT32 va229;
		UINT32 va230;
		UINT32 va231;
		UINT32 va232;
		UINT32 va233;
		UINT32 va234;
		UINT32 va235;
		UINT32 va236;
		UINT32 va237;
		UINT32 va238;
		UINT32 va239;
		UINT32 va240;
		UINT32 va241;
		UINT32 va242;
		UINT32 va243;
		UINT32 va244;
		UINT32 va245;
		UINT32 va246;
		UINT32 va247;
		UINT32 va248;
		UINT32 va249;
		UINT32 va250;
		UINT32 va251;
		UINT32 va252;
		UINT32 va253;
		UINT32 va254;
		UINT32 va255;
		UINT32 va256;
		UINT32 va257;
		UINT32 va258;
		UINT32 va259;
		UINT32 va260;
		UINT32 va261;
		UINT32 va262;
		UINT32 va263;
		UINT32 va264;
		UINT32 va265;
		UINT32 va266;
		UINT32 va267;
		UINT32 va268;
		UINT32 va269;
		UINT32 va270;
		UINT32 va271;
		UINT32 va272;
		UINT32 va273;
		UINT32 va274;
		UINT32 va275;
		UINT32 va276;
		UINT32 va277;
		UINT32 va278;
		UINT32 va279;
		UINT32 va280;
		UINT32 va281;
		UINT32 va282;
		UINT32 va283;
		UINT32 va284;
		UINT32 va285;
		UINT32 va286;
		UINT32 va287;
		UINT32 va288;
		UINT32 va289;
		UINT32 va290;
		UINT32 va291;
		UINT32 va292;
		UINT32 va293;
		UINT32 va294;
		UINT32 va295;
		UINT32 va296;
		UINT32 va297;
		UINT32 va298;
		UINT32 va299;
		UINT32 va300;
		UINT32 va301;
		UINT32 va302;
		UINT32 va303;
		UINT32 va304;
		UINT32 va305;
		UINT32 va306;
		UINT32 va307;
		UINT32 va308;
		UINT32 va309;
		UINT32 va310;
		UINT32 va311;
		UINT32 va312;
		UINT32 va313;
		UINT32 va314;
		UINT32 va315;
		UINT32 va316;
		UINT32 va317;
		UINT32 va318;
		UINT32 va319;
		UINT32 va320;
		UINT32 va321;
		UINT32 va322;
		UINT32 va323;
		UINT32 va324;
		UINT32 va325;
		UINT32 va326;
		UINT32 va327;
		UINT32 va328;
		UINT32 va329;
		UINT32 va330;
		UINT32 va331;
		UINT32 va332;
		UINT32 va333;
		UINT32 va334;
		UINT32 va335;
		UINT32 va336;
		UINT32 va337;
		UINT32 va338;
		UINT32 va339;
		UINT32 va340;
		UINT32 va341;
		UINT32 va342;
		UINT32 va343;
		UINT32 va344;
		UINT32 va345;
		UINT32 va346;
		UINT32 va347;
		UINT32 va348;
		UINT32 va349;
		UINT32 va350;
		UINT32 va351;
		UINT32 va352;
		UINT32 va353;
		UINT32 va354;
		UINT32 va355;
		UINT32 va356;
		UINT32 va357;
		UINT32 va358;
		UINT32 va359;
		UINT32 va360;
		UINT32 va361;
		UINT32 va362;
		UINT32 va363;
		UINT32 va364;
		UINT32 va365;
		UINT32 va366;
		UINT32 va367;
		UINT32 va368;
		UINT32 va369;
		UINT32 va370;
		UINT32 va371;
		UINT32 va372;
		UINT32 va373;
		UINT32 va374;
		UINT32 va375;
		UINT32 va376;
		UINT32 va377;
		UINT32 va378;
		UINT32 va379;
		UINT32 va380;
		UINT32 va381;
		UINT32 va382;
		UINT32 va383;
		UINT32 va384;
		UINT32 va385;
		UINT32 va386;
		UINT32 va387;
		UINT32 va388;
		UINT32 va389;
		UINT32 va390;
		UINT32 va391;
		UINT32 va392;
		UINT32 va393;
		UINT32 va394;
		UINT32 va395;
		UINT32 va396;
		UINT32 va397;
		UINT32 va398;
		UINT32 va399;
		UINT32 va400;
		UINT32 va401;
		UINT32 va402;
		UINT32 va403;
		UINT32 va404;
		UINT32 va405;
		UINT32 va406;
		UINT32 va407;
		UINT32 va408;
		UINT32 va409;
		UINT32 va410;
		UINT32 va411;
		UINT32 va412;
		UINT32 va413;
		UINT32 va414;
		UINT32 va415;
		UINT32 va416;
		UINT32 va417;
		UINT32 va418;
		UINT32 va419;
		UINT32 va420;
		UINT32 va421;
		UINT32 va422;
		UINT32 va423;
		UINT32 va424;
		UINT32 va425;
		UINT32 va426;
		UINT32 va427;
		UINT32 va428;
		UINT32 va429;
		UINT32 va430;
		UINT32 va431;
		UINT32 va432;
		UINT32 va433;
		UINT32 va434;
		UINT32 va435;
		UINT32 va436;
		UINT32 va437;
		UINT32 va438;
		UINT32 va439;
		UINT32 va440;
		UINT32 va441;
		UINT32 va442;
		UINT32 va443;
		UINT32 va444;
		UINT32 va445;
		UINT32 va446;
		UINT32 va447;
		UINT32 va448;
		UINT32 va449;
		UINT32 va450;
		UINT32 va451;
		UINT32 va452;
		UINT32 va453;
		UINT32 va454;
		UINT32 va455;
		UINT32 va456;
		UINT32 va457;
		UINT32 va458;
		UINT32 va459;
		UINT32 va460;
		UINT32 va461;
		UINT32 va462;
		UINT32 va463;
		UINT32 va464;
		UINT32 va465;
		UINT32 va466;
		UINT32 va467;
		UINT32 va468;
		UINT32 va469;
		UINT32 va470;
		UINT32 va471;
		UINT32 va472;
		UINT32 va473;
		UINT32 va474;
		UINT32 va475;
		UINT32 va476;
		UINT32 va477;
		UINT32 va478;
		UINT32 va479;
		UINT32 va480;
		UINT32 va481;
		UINT32 va482;
		UINT32 va483;
		UINT32 va484;
		UINT32 va485;
		UINT32 va486;
		UINT32 va487;
		UINT32 va488;
		UINT32 va489;
		UINT32 va490;
		UINT32 va491;
		UINT32 va492;
		UINT32 va493;
		UINT32 va494;
		UINT32 va495;
		UINT32 va496;
		UINT32 va497;
		UINT32 va498;
		UINT32 va499;
		UINT32 va500;
		UINT32 va501;
		UINT32 va502;
		UINT32 va503;
		UINT32 va504;
		UINT32 va505;
		UINT32 va506;


		Element();
		Element(const Element&);
		//0
		virtual ~Element();

		Element& operator=(const Element &);

		long Initialize(unsigned int, Element*, unsigned long*);
		static long WINAPI Create(unsigned int, Element*parent, unsigned long*, Element**out);
		static long WINAPI UnRegister(struct IClassInfo**);


		Element * GetParent(void);
		RECT const * GetPadding(Value * *);
		bool GetOverhang(void);
		Element * GetMouseWithinChild(void);
		bool GetMouseWithin(void);
		bool GetMouseFocused(void);
		SIZE const * GetMinSize(Value * *);
		RECT const * GetMargin(Value * *);
		POINT const * GetLocation(Value * *);
		int GetLayoutPos(void);
		Layout * GetLayout(Value * *);
		Element * GetKeyWithinChild(void);
		bool GetKeyWithin(void);
		int GetIndex(void);
		Element * GetImmediateChild(Element *);
		unsigned short GetID(void);
		bool GetHighDPI(void);
		int GetHeight(void);
		int GetForegroundStdColor(void);
		struct DirectUI::Fill const * GetForegroundColor(Value * *);
		int GetFontWeight(void);
		int GetFontStyle(void);
		int GetFontSize(void);
		int GetFontQuality(void);
		unsigned short const * GetFontFace(Value * *);
		unsigned short const * GetFont(Value * *);
		static CRITICAL_SECTION * __stdcall GetFactoryLock(void);
		SIZE const * GetExtent(Value * *);
		long GetEncodedContentString(unsigned short *, UINT_PTR);
		bool GetEnabled(void);

		int GetDPI(void);
		HGADGET GetDisplayNode(void);
		int GetDirection(void);
		SIZE const * GetDesiredSize(void);
		DeferCycle * GetDeferObject(void);
		unsigned short const * GetContentString(Value * *);
		int GetContentAlign(void);
		int GetColorize(void);
		bool GetClickablePoint(POINT *);
		static IClassInfo * __stdcall GetClassInfoPtr(void);
		unsigned short const * GetClass(Value * *);
		DynamicArray<Element *, 0> * GetChildren(Value * *);
		RECT const * GetBorderThickness(Value * *);
		int GetBorderStyle(void);
		int GetBorderStdColor(void);

		

		long AddListener(IElementListener*);

		unsigned long WINAPI AddRef();
		static UID WINAPI AnimationChange();

		void BroadcastEvent(struct Event*);
		void Detach(class DeferCycle*);

		//1
		virtual bool IsRTLReading();

		//2
		virtual bool IsContentProtected();


		//3
		virtual UCString GetContentStringAsDisplayed(class Value**);

		//4
		virtual bool OnPropertyChanging(PropertyInfo*, int, class Value*, class Value*);
		virtual bool OnPropertyChanging(const PropertyInfo*, int, class Value*, class Value*);
		//5
		//6
		virtual void OnPropertyChanged(PropertyInfo*, int, Value*, Value*);
		virtual void OnPropertyChanged(const PropertyInfo*, int, class Value*, class Value*);
		//7
		//8
		virtual void OnGroupChanged(int, bool);
		//9
		virtual void OnInput(struct InputEvent*);
		//10
		virtual void OnKeyFocusMoved(Element*, Element*);
		//11
		virtual void OnMouseFocusMoved(Element*, Element*);
		//12
		virtual void OnDestroy();
		//13
		virtual void OnEvent(Event*);
		//14
		virtual void Paint(HDC, RECT const*, RECT const*, RECT*, RECT*);

		//15
		virtual SIZE GetContentSize(int, int, class Surface*);

		//16
		virtual long Add(Element**, unsigned int);

		//long Add(Element*);
		//long Add(Element*, int(__cdecl*)(const void*, const void*));

		//17
		virtual long Insert(Element**, unsigned int, unsigned int);
		//18
		virtual long Remove(Element**, unsigned int);

		//19
		virtual Element* GetAdjacent(Element*, int, const struct NavReference*, unsigned long);

		//20
		virtual bool EnsureVisible(int, int, int, int);
		virtual void SetKeyFocus(void);

		virtual long AddBehavior(IDuiBehavior* behavior);
		virtual long RemoveBehavior(IDuiBehavior* behavior);

		//21

		//22
		virtual unsigned int MessageCallback(GMSG*);

		//23
		virtual long WINAPI QueryInterface(GUID const &, void**);

		virtual void GetImmersiveFocusRectOffsets(RECT*);



		long Destroy(bool);
		long DestroyAll(bool);
		void DoubleBuffered(bool);
		void EnableUiaEvents(bool);
		void EndDefer(unsigned long);
		bool EnsureVisible(unsigned int);
		bool EnsureVisible(void);
		Element* FindDescendent(ATOM id);
		void FireEvent(struct Event*, bool, bool);

		bool GetAbsorbsShortcut();
		UCString GetAccDefAction(Value**);
		UCString GetAccDesc(Value**);
		UCString GetAccHelp(Value**);
		UCString GetAccItemStatus(Value**);
		UCString GetAccItemType(Value**);
		UCString GetAccName(Value**);
		UCString GetAccNameAsDisplayed(Value**);
		UCString GetAccValue(Value**);

		int GetAccRole();
		int GetAccState();
		bool GetAccessible();
		int GetActive();
		Element* GetRoot();

		// Properties? wtf is this

		static const PropertyInfo* WINAPI AbsorbsShortcutProp();
		static const PropertyInfo* WINAPI AccDefActionProp();
		static const PropertyInfo* WINAPI AccDescProp();
		static const PropertyInfo* WINAPI AccHelpProp();
		static const PropertyInfo* WINAPI AccItemStatusProp();
		static const PropertyInfo* WINAPI AccItemTypeProp();
		static const PropertyInfo* WINAPI AccNameProp();
		static const PropertyInfo* WINAPI AccRoleProp();
		static const PropertyInfo* WINAPI AccStateProp();
		static const PropertyInfo* WINAPI AccValueProp();
		static const PropertyInfo* WINAPI AccessibleProp();
		static const PropertyInfo* WINAPI ActiveProp();
		static const PropertyInfo* WINAPI AlphaProp();
		static const PropertyInfo* WINAPI AnimationProp();
		static const PropertyInfo* WINAPI BackgroundProp();
		static const PropertyInfo* WINAPI BorderColorProp();
		static const PropertyInfo* WINAPI BorderStyleProp();
		static const PropertyInfo* WINAPI BorderThicknessProp();
		static const PropertyInfo* WINAPI ChildrenProp();
		static const PropertyInfo* WINAPI ClassProp();
		static const PropertyInfo* WINAPI CompositedTextProp();
		static const PropertyInfo* WINAPI ContentAlignProp();

		static const PropertyInfo* WINAPI ContentProp();
		static const PropertyInfo* WINAPI CursorProp();
		static const PropertyInfo* WINAPI CustomProp();
		static const PropertyInfo* WINAPI DPIProp();
		static const PropertyInfo* WINAPI DirectionProp();
		static const PropertyInfo* WINAPI DesiredSizeProp();
		static const PropertyInfo* WINAPI ExtentProp();
		static const PropertyInfo* WINAPI ForegroundProp();
		static const PropertyInfo* WINAPI FontFaceProp();
		static const PropertyInfo* WINAPI FontProp();
		static const PropertyInfo* WINAPI FontQualityProp();
		static const PropertyInfo* WINAPI FontSizeProp();
		static const PropertyInfo* WINAPI FontStyleProp();
		static const PropertyInfo* WINAPI FontWeightProp();
		static const PropertyInfo* WINAPI KeyFocusedProp();
		static const PropertyInfo* WINAPI KeyWithinProp();
		static const PropertyInfo* WINAPI LastDSConstProp();
		static const PropertyInfo* WINAPI LayoutPosProp();
		static const PropertyInfo* WINAPI LayoutProp();
		static const PropertyInfo* WINAPI LocationProp();
		static const PropertyInfo* WINAPI HeightProp();
		static const PropertyInfo* WINAPI HighDPIProp();
		static const PropertyInfo* WINAPI IDProp();
		static const PropertyInfo* WINAPI MinSizeProp();
		static const PropertyInfo* WINAPI MouseFocusedProp();
		static const PropertyInfo* WINAPI MouseWithinProp();
		static const PropertyInfo* WINAPI OverhangProp();
		static const PropertyInfo* WINAPI PaddingProp();
		static const PropertyInfo* WINAPI ParentProp();
		static const PropertyInfo* WINAPI PosInLayoutProp();
		static const PropertyInfo* WINAPI SelectedProp();
		static const PropertyInfo* WINAPI ShadowIntensityProp();
		static const PropertyInfo* WINAPI SheetProp();
		static const PropertyInfo* WINAPI ShortcutProp();
		static const PropertyInfo* WINAPI SizeInLayoutProp();
		static const PropertyInfo* WINAPI TextGlowSizeProp();
		static const PropertyInfo* WINAPI TooltipMaxWidthProp();
		static const PropertyInfo* WINAPI TooltipProp();
		static const PropertyInfo* WINAPI VisibleProp();
		static const PropertyInfo* WINAPI WidthProp();
		static const PropertyInfo* WINAPI WindowActiveProp();
		static const PropertyInfo* WINAPI XProp();
		static const PropertyInfo* WINAPI YProp();

		long GetRootRelativeBounds(LPRECT);
		bool GetSelected();
		int GetShadowIntensity();
		StyleSheet* GetSheet();
		int GetShortcut();
		UChar GetShortcutChar();
		int GetTextGlowSize();
		bool GetTooltip();
		int GetTooltipMaxWidth();
		Element* GetTopLevel();
		float GetTreeAlphaLevel();
		Value* GetValue( const PropertyInfo* (WINAPI*)(void), int, UpdateCache*);
		Value* GetValue(const PropertyInfo*, int, UpdateCache*);
		bool GetVisible();
		int GetWidth();
		bool GetWindowActive();
		int GetX();
		int GetY();

		bool HasAnimation();
		bool HasBorder();
		bool HasChildren();
		bool HasContent();
		bool HasLayout();
		bool HasMargin();
		bool HasPadding();
		static void WINAPI InitDefaultFontSize();
		static UID WINAPI KeyboardNavigate();

		long Insert(Element*, unsigned int);
		
		void InvokeAnimation(int, unsigned int);
		void InvokeAnimation(unsigned int, unsigned int, float, float, bool);
		bool IsCompositedText();
		
		bool IsDefaultCAlign();
		bool IsDefaultCursor();
		bool IsDescendent(Element*);
		bool IsDestroyed();
		bool IsHosted();
		bool IsRTL();
		
		int IsRoot();
		bool IsSelfLayout();
		bool IsValidAccessor(const PropertyInfo*, int, bool);
		static bool WINAPI IsValidValue(const PropertyInfo*, Value*);
		bool IsWordWrap();
		void MapElementPoint(Element*, POINT const*, LPPOINT);
		static const PropertyInfo* WINAPI MarginProp();

		void MarkNeedsDSUpdate();
		bool NeedsDSUpdate();

		
		

		void PaintBackground(HDC, Value*, RECT const &, RECT const &, RECT const &, RECT const &);
		void PaintBorder(HDC, Value*, RECT*, RECT const &);
		void PaintContent(HDC, RECT const*);
		void PaintFocusRect(HDC, RECT const*, RECT const*);
		void PaintStringContent(HDC, RECT const*, Value*, int);

		void PostEvent(Event*);
		long QueueDefaultAction();
		static long WINAPI Register();
		unsigned long WINAPI Release();
		long Remove(Element*);
		long RemoveAll();
		void RemoveListener(struct IElementListener*);
		long RemoveLocalValue( const PropertyInfo* (WINAPI*)(void));
		long RemoveLocalValue(const PropertyInfo*);

		long SetAbsorbsShortcut(bool);
		long SetAccDefAction(UCString);
		long SetAccDesc(UCString);
		long SetAccHelp(UCString);
		long SetAccItemStatus(UCString);
		long SetAccItemType(UCString);
		long SetAccName(UCString);
		long SetAccRole(int);
		long SetAccState(int);
		long SetAccValue(UCString);
		long SetAccessible(bool);
		long SetActive(int);
		long SetAlpha(int);
		long SetAnimation(int);
		long SetBackgroundColor(Fill const &);
		long SetBackgroundColor(unsigned long);
		long SetBackgroundColor(unsigned long, unsigned long, unsigned char);
		long SetBackgroundColor(unsigned long, unsigned long, unsigned long, unsigned char);
		long SetBackgroundColor(UCString, int, int);
		long SetBackgroundStdColor(int);
		long SetBorderColor(unsigned long);
		long SetBorderGradientColor(unsigned long, unsigned long, unsigned char);
		long SetBorderStdColor(int);
		long SetBorderStyle(int);
		long SetBorderThickness(int, int, int, int);
		long SetClass(UCString);
		static void WINAPI SetClassInfoPtr(IClassInfo*);
		long SetCompositedText(bool);
		long SetContentAlign(int);
		long SetContentGraphic(UCString, unsigned char, unsigned int);
		long SetContentGraphic(UCString, unsigned short, unsigned short);
		long SetContentString(UCString);
		long SetCursor(UCString);
		long SetCursorHandle(HICON);
		long SetDirection(int);
		long SetEnabled(bool);
		long SetEncodedContentString(UCString);
		long SetFont(UCString);
		long SetFontFace(UCString);
		long SetFontQuality(int);
		long SetFontSize(int);
		long SetFontStyle(int);
		long SetFontWeight(int);
		long SetForegroundColor(unsigned long);
		long SetForegroundColor(unsigned long, unsigned long, unsigned char);
		long SetForegroundColor(unsigned long, unsigned long, unsigned long, unsigned char);
		long SetForegroundStdColor(int);
		long SetHeight(int);
		long SetID(UCString);
		long SetLayout(class Layout*);
		long SetLayoutPos(int);
		long SetMargin(int, int, int, int);
		long SetMinSize(int, int);
		long SetOverhang(bool);
		long SetPadding(int, int, int, int);
		long SetSelected(bool);
		long SetShadowIntensity(int);
		long SetSheet(StyleSheet*);
		long SetShortcut(int);
		long SetStdCursor(int);
		long SetTextGlowSize(int);
		long SetTooltip(bool);
		long SetTooltipMaxWidth(int);
		long SetValue( const PropertyInfo* (WINAPI*)(void), int, Value*);
		long SetValue(const PropertyInfo*, int, Value*);
		long SetVisible(bool);
		long SetWidth(int);
		long SetWindowActive(bool);
		long SetX(int);
		long SetY(int);

		long SortChildren(int (*)(void const*, void const*));
		void StartDefer(unsigned long*);
		void StopAnimation(unsigned int);
		DeferCycle* TestDeferObject();
		bool UiaEvents();
		void UpdateLayout();
		static void WINAPI _AddDependency(Element*, const PropertyInfo*, int, struct DepRecs*, DeferCycle*, long*);
		void _ClearNeedsLayout();
		static long WINAPI _DisplayNodeCallback(HGADGET, void*, struct EventMsg*);
		void _EndOptimizedLayoutQ();
		int _GetChangesUpdatePass();
		unsigned int _GetNeedsLayout();
		static int WINAPI _MarkElementForDS(Element*);
		static int WINAPI _MarkElementForLayout(Element*, unsigned int);
		static bool WINAPI _SetGroupChanges(Element*, int, DeferCycle*);
		int _SetNeedsLayout(unsigned int);
		void _StartOptimizedLayoutQ(void);
		static void WINAPI _TransferGroupFlags(Element*, int);
		SIZE _UpdateDesiredSize(int, int, Surface*);
		void _UpdateLayoutPosition(int, int);
		void _UpdateLayoutSize(int, int);
		static PropertyInfo const * __stdcall EnabledProp();
		int GetAlpha(void);
		int GetAnimation(void);
		Fill const * GetBackgroundColor(Value * *);
		int GetBackgroundStdColor(void);
		Fill const * GetBorderColor(Value * *);
	protected:
		//24
		virtual void _SelfLayoutDoLayout(int, int);

		//25
		virtual SIZE _SelfLayoutUpdateDesiredSize(int, int, Surface*);

		//26
		virtual void OnHosted(Element*);
		//27
		virtual void OnUnHosted(Element*);
		//28
		virtual void UpdateTooltip(Element*);
		//29
		virtual void ActivateTooltip(Element*, unsigned long);
		//30
		virtual void RemoveTooltip(Element*);
public:

		//31
		virtual bool GetKeyFocused();

		//32
		virtual IClassInfo* GetClassInfoW();
		//33
		virtual long GetAccessibleImpl(IAccessible**);

		//34
		virtual long DefaultAction();
		virtual long GetUIAElementProvider(GUID const&, void** param2);
		//35
		virtual HRESULT GetElementProviderImpl(class InvokeHelper *, ElementProvider * *);


		//36
		virtual void HandleUiaDestroyListener();
		//37
		virtual void HandleUiaPropertyListener(const PropertyInfo*, int, Value*, Value*);
		//38
		virtual void HandleUiaPropertyChangingListener(const PropertyInfo*);
		//39
		virtual void HandleUiaEventListener(Event*);

		virtual Element* GetUiaFocusDelegate();

		
protected:

		void MarkHosted();
		void MarkSelfLayout();
		static void WINAPI _FlushLayout(Element*, DeferCycle*);
		static void WINAPI _InvalidateCachedDSConstraints(Element*);
		void _OnFontPropChanged(Value*);
		long _RemoveLocalValue( const PropertyInfo* (WINAPI*)(void), bool);
		long _RemoveLocalValue(const PropertyInfo*, bool);
		long _SetValue( const PropertyInfo* (WINAPI*)(void), int, Value*, bool);
		long _SetValue(const PropertyInfo*, int, Value*, bool);
private:
		Element* FindDescendentWorker(unsigned short);
		void _SyncBackground();
		void _SyncRedrawStyle();
		void _SyncVisible();
		bool IsPointValid(double, double);
		unsigned short* RemoveShortcutFromName(UCString);
		bool TryLinePattern(LPPOINT, const RECT&);
		bool TryPattern(double, double, LPPOINT, const RECT&);
		bool TrySparsePattern(LPPOINT, const RECT&);
		void _BroadcastEventWorker(Event*);
		int _CachedValueIsEqual(const PropertyInfo*, Element*);
		void _GetBuriedSheetDependencies(const PropertyInfo*, Element*, struct DepRecs*, DeferCycle*, long*);
		void _UpdatePropertyInCache(const PropertyInfo*);
		static void WINAPI _VoidPCNotifyTree(int, DeferCycle*);
		

		void _FlushDS(DeferCycle*);
		Value* _GetComputedValue(const PropertyInfo*, UpdateCache*);
		long _GetDependencies(const PropertyInfo*, int, struct DepRecs*, int, Value*, DeferCycle*);
		Value* _GetLocalValue(const PropertyInfo*);
		Value* _GetLocalValueFromVM(const PropertyInfo*);
		Value* _GetSpecifiedValue(const PropertyInfo*, UpdateCache*);
		Value* _GetSpecifiedValueIgnoreCache(const PropertyInfo*);
		void _InheritProperties();
		long _PostSourceChange();
		long _PreSourceChange( const PropertyInfo* (WINAPI*)(void), int, Value*, Value*);
		long _PreSourceChange(const PropertyInfo*, int, Value*, Value*);

		unsigned int GetCommonDrawTextFlags(int);



		static IClassInfo*s_pClassInfo;
	};

	class UILIB_API ElementProxy : public IProxy
	{
	public:
		ElementProxy(ElementProxy const &);
		ElementProxy(void);
		ElementProxy & operator=(ElementProxy const &);

		static ElementProxy * __stdcall Create(Element *);
		//1
		virtual long DoMethod(int, char *);
	protected:
		long GetAutomationId(VARIANT *);
		long GetBoundingRect(UiaRect *);
		long GetContent(VARIANT *, IAccessible *);
		void GetControlType(VARIANT *, IAccessible *);
		long GetFragmentRoot(IRawElementProviderFragmentRoot * *);
		long GetHwnd(HWND *);
		long GetLabel(VARIANT *);
		long GetProperty(VARIANT *, int);
		long GetProviderOptions(ProviderOptions *);
		long GetRuntimeId(SAFEARRAY * *);
		long IsPatternSupported(Schema::Pattern, bool *);
		long Navigate(NavigateDirection, IRawElementProviderFragment**);
		long SetString(VARIANT *, UCString (Element::*)(Value * *));
		int _UsesUIAProxies(void);

		//2
		virtual void Init(Element *);

	};

	//此类的声明很可能错误
	class UILIB_API ElementProvider
		: public RefcountBase
		, public IRawElementProviderSimple
		, public IRawElementProviderFragment
		, public IRawElementProviderAdviseEvents
	{
	public:
		ElementProvider();
		ElementProvider(const ElementProvider&) = delete;
		virtual ~ElementProvider();

		static long WINAPI Create(Element*, class InvokeHelper*, ElementProvider**out);

		long DoInvokeArgs(int, ProviderProxyCall, char*);
		const Element* GetElementKey();
		void TossElement();
		void TossPatternProvider(Schema::Pattern);


		//IUnknown
		virtual unsigned long WINAPI AddRef();
		virtual unsigned long WINAPI Release();
		virtual long WINAPI QueryInterface(const GUID&, void**);

		//IRawElementProviderSimple
		virtual /* [propget] */ HRESULT STDMETHODCALLTYPE get_ProviderOptions(
			/* [retval][out] */ __RPC__out enum ProviderOptions *pRetVal);

		virtual HRESULT STDMETHODCALLTYPE GetPatternProvider(
			/* [in] */ PATTERNID patternId,
			/* [retval][out] */ __RPC__deref_out_opt IUnknown **pRetVal);

		virtual HRESULT STDMETHODCALLTYPE GetPropertyValue(
			/* [in] */ PROPERTYID propertyId,
			/* [retval][out] */ __RPC__out VARIANT *pRetVal);

		virtual /* [propget] */ HRESULT STDMETHODCALLTYPE get_HostRawElementProvider(
			/* [retval][out] */ __RPC__deref_out_opt IRawElementProviderSimple **pRetVal);

		//IRawElementProviderFragment
		virtual HRESULT STDMETHODCALLTYPE Navigate(
			/* [in] */ enum NavigateDirection direction,
			/* [retval][out] */ __RPC__deref_out_opt IRawElementProviderFragment **pRetVal);

		virtual HRESULT STDMETHODCALLTYPE GetRuntimeId(
			/* [retval][out] */ __RPC__deref_out_opt SAFEARRAY * *pRetVal);

		virtual HRESULT STDMETHODCALLTYPE get_BoundingRectangle(
			/* [retval][out] */ __RPC__out UiaRect *pRetVal);

		virtual HRESULT STDMETHODCALLTYPE GetEmbeddedFragmentRoots(
			/* [retval][out] */ __RPC__deref_out_opt SAFEARRAY * *pRetVal);

		virtual HRESULT STDMETHODCALLTYPE SetFocus(void);

		virtual /* [propget] */ HRESULT STDMETHODCALLTYPE get_FragmentRoot(
			/* [retval][out] */ __RPC__deref_out_opt IRawElementProviderFragmentRoot **pRetVal);

		//IRawElementProviderAdviseEvents
		virtual HRESULT STDMETHODCALLTYPE AdviseEventAdded(
			/* [in] */ EVENTID eventId,
			/* [in] */ __RPC__in SAFEARRAY * propertyIDs);

		virtual HRESULT STDMETHODCALLTYPE AdviseEventRemoved(
			/* [in] */ EVENTID eventId,
			/* [in] */ __RPC__in SAFEARRAY * propertyIDs);

		//1 此函数似乎声明不正确
		virtual ProviderProxyCall GetProxyCreator();
		//2
		virtual volatile const Element* GetElement();

	protected:
		//3
		virtual long Init(Element*, InvokeHelper*);
		long DoInvoke(int, ...);
	};

	class UILIB_API ElementProviderManager
	{
	public:
		ElementProviderManager & operator=(ElementProviderManager const &);

		static long WINAPI Add(ElementProvider *);
		static void WINAPI Close();
		static ElementProvider *WINAPI Find(Element *);
		static long WINAPI Init();
		static void WINAPI Remove(ElementProvider *);

		static CRITICAL_SECTION g_cs;
	private:
		static bool WINAPI FindProviderCallback(ElementProvider *, void *);

		static UiaArray<ElementProvider *> * g_pArrayPprv;
	};

}